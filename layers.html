<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Display a map</title>

    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

    <script src="https://unpkg.com/maplibre-gl@2.1.7/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.1.7/dist/maplibre-gl.css" rel="stylesheet" />

    <style>
      body { margin: 0; padding: 0; }
      #map { position: absolute; top: 0; bottom: 0; width: 100%; }
      #legend { position: absolute; right: 0; pointer-events: none; color: white; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="legend"></div>

    <script type="module">
      const style = await (await fetch("./style.json")).json();

      style.layers = [];

      style.layers.push({
        "id": "water",
        "source": "openmaptiles",
        "source-layer": "water",
        "type": "fill",
        "paint": {
          "fill-color": "aliceblue",
        },
      });

      const casingColor = [
        "interpolate-lab",
        ["linear"],
        ["number", ["get", "layer"], 0],
        -5,
        "maroon",
        0,
        "bisque",
        5,
        "aliceblue",
      ];

      const baseLineLayer = {
        type: "line",
        source: "openmaptiles",
        filter: [
          "all",
          ["in", ["geometry-type"], ["literal", ["LineString", "MultiLineString"]]],
        ],
        paint: {
          "line-width": 1,
        },
      };

      const baseAreaLayer = {
        type: "fill",
        source: "openmaptiles",
        filter: [
          "all",
          ["in", ["geometry-type"], ["literal", ["Polygon", "MultiPolygon"]]],
        ],
      };

      const bridgeBase = {
        ...baseAreaLayer,
        id: "bridge",
        "source-layer": "transportation",
        paint: {
          "fill-color": casingColor,
          "fill-opacity": 0.9,
        },
      };

      const transportationBase = {
        ...baseLineLayer,
        "id": "transportation",
        "source-layer": "transportation",
        "paint": {
          ...baseLineLayer.paint,
          "line-color": [
            "match",
            ["get", "class"],
            "motorway",
            "red",
            "trunk",
            "red",
            "primary",
            "indianred",
            "secondary",
            "indianred",
            "tertiary",
            "indianred",
            "minor",
            "pink",
            "service",
            "pink",
            "track",
            "pink",
            "path",
            "mediumaquamarine",
            "rail",
            "goldenrod",
            "transit",
            "goldenrod",
            "fuchsia",
          ],
        },
      };

      const waterwayBase = {
        ...baseLineLayer,
        "id": "waterway",
        "source-layer": "waterway",
        "paint": {
          ...baseLineLayer.paint,
          "line-color": "blue",
        },
      };

      const aerowayBase = {
        ...baseLineLayer,
        "id": "aeroway",
        "source-layer": "aeroway",
        "paint": {
          ...baseLineLayer.paint,
          "line-color": "silver",
        },
      };

      const buildAreaLayer = (template, layer_value) => {
        const localLayer = {
          ...template,
          filter: [...template.filter],
        };
        const layerFilters = ["any"];
        layerFilters.push(
          ["==", ["get", "layer"], layer_value],
        );
        switch (layer_value) {
          case 0:
            layerFilters.push(
              ["!", ["has", "layer"]],
            );
            break;
        }
        localLayer.filter.push(layerFilters);
        const bridgeArea = {
          ...localLayer,
          id: `${localLayer.id}-${layer_value}-bridgeArea`,
          filter: [
            "all",
            localLayer.filter,
            ["==", ["get", "class"], ["literal", "bridge"]],
          ],
        };
        return {bridgeArea};
      };

      const buildLineLayer = (template, layer_value) => {
        const localLayer = {
          ...template,
          filter: [...template.filter],
        };

        const layerFilters = ["any"];
        layerFilters.push(
          ["==", ["get", "layer"], layer_value],
        );
        if (layer_value == 0) {
          layerFilters.push(
            ["!", ["has", "layer"]],
          );
        }
        localLayer.filter.push(layerFilters);

        const casing = {
          ...localLayer,
          id: `${localLayer.id}-${layer_value}-casing`,
          paint: {
            ...localLayer.paint,
            "line-color": casingColor,
            "line-width": [
              "interpolate",
              ["exponential", 2],
              ["zoom"],
              14,
              10,
              18,
              20,
            ],
          },
        };
        const bridgeCasing = {
          ...localLayer,
          id: `${localLayer.id}-${layer_value}-bridgeCasing`,
          filter: [
            "all",
            localLayer.filter,
            ["==", ["get", "brunnel"], "bridge"],
          ],
          paint: {
            ...localLayer.paint,
            "line-color": [
              "string",
              "black",
            ],
            "line-gap-width": 1,
            "line-width": 1,
          },
        };
        const stroke = {
          ...localLayer,
          filter: [
            "all",
            localLayer.filter,
            ["!=", ["get", "brunnel"], "tunnel"],
          ],
          id: `${localLayer.id}-${layer_value}-stroke`,
        }
        const tunnelStroke = {
          ...localLayer,
          id: `${localLayer.id}-${layer_value}-tunnelStroke`,
          filter: [
            "all",
            localLayer.filter,
            ["==", ["get", "brunnel"], "tunnel"],
          ],
          paint: {
            ...localLayer.paint,
            "line-dasharray": [3, 3],
          },
        };
        return {casing, bridgeCasing, stroke, tunnelStroke};
      };

      const layer_values = [...Array(9)].map((_, i) => i - 3);

      const layers = [];
      for (const layer_value of layer_values) {
        const thisLayerCasing = [];
        const thisLayerBridgeArea = [];
        const thisLayerBridgeCasing = [];
        const thisLayerStroke = [];
        const thisLayerTunnelStroke = [];
        // No layers until z9
        // But put water first, at least
        const templates = [];
        if (layer_value >= -1 && layer_value <= 1) {
          templates.push(waterwayBase);
        }
        templates.push(transportationBase);
        if (layer_value == 0) {
          templates.push(aerowayBase);
        }
        const {bridgeArea} = buildAreaLayer(bridgeBase, layer_value);
        thisLayerBridgeArea.push(bridgeArea);
        for (const template of templates) {
          const {casing, bridgeCasing, stroke, tunnelStroke} = buildLineLayer(template, layer_value);
          thisLayerCasing.push(casing);
          thisLayerCasing.push(bridgeCasing);
          thisLayerStroke.push(stroke);
          thisLayerTunnelStroke.push(tunnelStroke);
        }
        layers.push(...thisLayerBridgeArea);
        layers.push(...thisLayerCasing);
        layers.push(...thisLayerBridgeCasing);
        layers.push(...thisLayerStroke);
        layers.push(...thisLayerTunnelStroke);
      }

      style.layers.push(...layers);

      var map = (window.map = new maplibregl.Map({
        container: "map",
        style,
        center: [-84.5, 39.1],
        zoom: 12,
        hash: true,
      }));
      map.addControl(new maplibregl.ScaleControl());
      map.dragRotate.disable();
      map.touchZoomRotate.disableRotation();
      map.touchPitch.disable();
      map.keyboard.disableRotation();
      map.getCanvas().focus();
    </script>
  </body>
</html>
