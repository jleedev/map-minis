<!doctype html>
<html>
<head>

<meta charset="utf-8" />
<title>xray</title>

<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

<script src="https://unpkg.com/maplibre-gl@2.1.7/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@2.1.7/dist/maplibre-gl.css" rel="stylesheet" />

<style>
:root { user-select: none; }
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
#legend { position: absolute; right: 0; color: white; }
#legend .chip { display: inline-block; width: 1ch; height: 1ch; }
label:hover { background: gainsboro; }
label.checked-false { text-decoration: line-through; color: silver; }
</style>

</head>
<body>

<div id="map"></div>
<div id="legend"></div>

<script type=module>

  const toggleLayer = (event) => {
    const { target: { checked, name, parentElement: label } } = event;
    label.classList.toggle(`checked-true`, checked);
    label.classList.toggle(`checked-false`, !checked);
    const visibility = checked ? "visible": "none";
    map.getStyle().layers.forEach((layer) => {
      if (layer["source-layer"] === name) {
        map.setLayoutProperty(layer.id, "visibility", visibility);
      }
    });
  };

  const loadLayers = (map, vectorLayerIds) => {
    map.addLayer({"id":"background","type":"background","paint":{"background-color":"#000"}});

    const legendForm = document.createElement("form");
    legend.append(legendForm);

    let hue = 0;
    vectorLayerIds.forEach(layer => {

      hue += 25;
      let lineColor = `hsla(${hue}, 50%, 50%, 0.7)`;
      let fillColor = `hsla(${hue}, 50%, 50%, 0.4)`;
      let pointColor = `hsla(${hue}, 50%, 50%, 0.8)`;

      let legendItem = document.createElement('div');
      legendItem.innerHTML = `<label class=checked-true>
          <input hidden checked type=checkbox name="${layer}">
          <div class=chip style="background-color:hsl(${hue},50%,50%"></div>
          ${layer}
        </label><br>`;
      legendForm.append(legendItem);
      legendItem.addEventListener("input", toggleLayer);

      map.addLayer({
        "id": `${layer}-point`,
        "type": "circle",
        "source": "openmaptiles",
        "source-layer": layer,
        "filter": [
          "match",
          ["geometry-type"],
          ["Point", "MultiPoint"],
          true,
          false,
        ],
        "paint": {
          "circle-color": pointColor,
          "circle-pitch-alignment": "map",
        },
      });

      map.addLayer({
        "id": `${layer}-line`,
        "type": "line",
        "source": "openmaptiles",
        "source-layer": layer,
        "filter": [
          "match",
          ["geometry-type"],
          ["LineString", "MultiLineString"],
          true,
          false,
        ],
        "paint": {
          "line-color": lineColor,
        },
      });

      map.addLayer({
        "id": `${layer}-area`,
        "type": "fill",
        "source": "openmaptiles",
        "source-layer": layer,
        "filter": [
          "match",
          ["geometry-type"],
          ["Polygon", "MultiPolygon"],
          true,
          false,
        ],
        "paint": {
          "fill-color": fillColor,
          "fill-outline-color": lineColor,
        },
      });

      map.addLayer({
        "id": `${layer}-text-line`,
        "type": "symbol",
        "source": "openmaptiles",
        "source-layer": layer,
        "filter": [
          "match",
          ["geometry-type"],
          ["LineString", "MultiLineString"],
          true,
          false,
        ],
        "layout": {
          "text-field": ["coalesce", ["get", "name"], ["get", "ref"], ["get", "subclass"], ["get", "class"], ["get", "admin_level"], "?"],
          "text-font": ["Metropolis Light"],
          "text-size": 10,
          "symbol-placement": "line",
          "symbol-spacing": 75,
        },
        "paint": {
          "text-color": "#000000",
          "text-halo-width": 2,
          "text-halo-blur": 2,
          "text-halo-color": lineColor,
        },
      });

      map.addLayer({
        "id": `${layer}-text-point`,
        "type": "symbol",
        "source": "openmaptiles",
        "source-layer": layer,
        "filter": [
          "any",
          ["==", ["geometry-type"], "Point"],
          ["==", ["geometry-type"], "MultiPoint"],
        ],
        "layout": {
          "text-field": ["coalesce", ["get", "name"], ["get", "ref"], ["get", "subclass"], ["get", "class"], ["get", "admin_level"], ["get", "housenumber"], "?"],
          "text-font": ["Metropolis Light"],
          "text-size": 10,
          "symbol-placement": "point",
        },
        "paint": {
          "text-color": "#000000",
          "text-halo-width": 2,
          "text-halo-blur": 2,
          "text-halo-color": lineColor,
        },
      });

    });
  };

  var map = window.map = new maplibregl.Map({
    container: 'map',
    style: "style.json",
    center: [0, 0],
    zoom: 1,
    hash: true,
  });
  map.addControl(new maplibregl.ScaleControl());
  map.dragRotate.disable();
  map.touchZoomRotate.disableRotation();
  map.touchPitch.disable();
  map.keyboard.disableRotation();
  map.getCanvas().focus();

  const onSourceLayers = () => {
    const { vectorLayerIds } = map.getSource("openmaptiles");
    if (vectorLayerIds) {
      map.off("sourcedata", onSourceLayers);
      loadLayers(map, vectorLayerIds);
    }
  };
  map.on("sourcedata", onSourceLayers);

</script>

</body>
</html>
